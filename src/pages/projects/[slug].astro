---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navbar from "../../components/Navbar.astro";
import Footer from "../../components/Footer.astro";

import fs from "fs";
import path from "path";
import matter from "gray-matter";
import { marked } from "marked";

export async function getStaticPaths() {
  const projectsDir = "./src/projects";
  const projectFolders = fs
    .readdirSync(projectsDir)
    .filter((f) => fs.statSync(path.join(projectsDir, f)).isDirectory());

  return projectFolders.map((folder) => ({
    params: { slug: folder },
    props: {},
  }));
}

const { slug } = Astro.params;
const projectDir = `./src/projects/${slug}`;
const mdPath = path.join(projectDir, "index.md");

if (!fs.existsSync(mdPath)) {
  throw new Error(`Proyecto "${slug}" no encontrado`);
}

const raw = fs.readFileSync(mdPath, "utf-8");
const { data: frontmatter, content } = matter(raw);

const bodyMd =
  (frontmatter.mainText && String(frontmatter.mainText)) || content || "";
const htmlContent = marked.parse(bodyMd);

const preview = `/src/projects/${slug}/preview.jpg`;
---

<BaseLayout>
  <Navbar />
  <section class="py-20 flex justify-center">
    <div class="w-full max-w-[750px] px-6">
      <h1 class="text-4xl font-bold mb-5 text-center neon-text">{frontmatter.title}</h1>
      <img src={preview} alt={frontmatter.title} class="w-full rounded-lg mb-6" />
      <div class="project-content prose max-w-none text-gray-200 text-justify" set:html={htmlContent}></div>
    </div>
  </section>
  <Footer />
</BaseLayout>
